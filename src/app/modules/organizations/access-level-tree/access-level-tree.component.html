<seed-page
  class="flex flex-auto flex-col"
  [config]="{
    title: 'Access Level Tree',
    titleIcon: 'fa-solid:sitemap',
    action: toggleDrawer,
    actionIcon: 'heroicons-outline:bars-3',
    actionClasses: 'inline-flex md:hidden',
  }"
>
  <mat-drawer-container class="h-full flex-auto">
    <mat-drawer class="w-72 dark:bg-gray-900" [mode]="drawerMode" [(opened)]="drawerOpened">
      <div class="flex w-full flex-col">
        <div class="mx-6 mb-8 mt-10 text-3xl font-extrabold leading-none tracking-tight">Access Levels</div>

        <button class="mx-6" mat-flat-button color="primary">
          <mat-icon class="icon-size-4" svgIcon="fa-regular:pen-to-square"></mat-icon>
          <span class="ml-2">Edit</span>
        </button>

        <ol class="mx-6 mt-8 list-inside list-decimal space-y-4 font-bold">
          @for (level of accessLevelNames; track level) {
            <li class="pl-5 -indent-5">{{ level }}</li>
          }
        </ol>
      </div>
    </mat-drawer>

    <mat-drawer-content class="flex flex-col overflow-hidden">
      <div class="relative flex h-full flex-auto flex-col overflow-hidden">
        <div class="mx-6 mb-8 mt-10 text-3xl font-extrabold leading-none tracking-tight">Access Level Instances</div>
        <div class="max-w-3xl p-6">
          <div>Filter</div>
          <div class="flex h-6 items-center">
            <div class="inline-flex h-[22px] select-none items-center rounded-md bg-gray-200 px-2 text-sm dark:bg-gray-800">
              {{ accessLevelNames[0] }}
            </div>
          </div>
          <ng-container *ngTemplateOutlet="instanceTemplate; context: { $implicit: accessLevelTree, depth: 0 }"></ng-container>
        </div>
      </div>
    </mat-drawer-content>
  </mat-drawer-container>
</seed-page>

<ng-template let-tree let-depth="depth" #instanceTemplate>
  @for (instance of tree; track instance.id) {
    @let isExpanded = expanded.has(instance.id);
    @let hasChildren = instance.children?.length > 0;
    <div
      class="relative flex flex-col overflow-hidden"
      [ngClass]="{
        'pl-8 before:absolute before:start-3 before:top-0 before:ms-[calc(0.375rem+1px)] before:h-full before:w-0.5 before:bg-gray-200 before:dark:bg-gray-800':
          depth > 0,
      }"
    >
      <div
        class="group flex h-10 w-full select-none items-center rounded-lg hover:bg-hover"
        [ngClass]="hasChildren ? 'cursor-pointer' : 'cursor-default'"
        (click)="hasChildren && toggleExpand(instance.id)"
      >
        @if (hasChildren) {
          <div class="flex min-w-10 items-center justify-center">
            <mat-icon class="h-4 min-h-4 w-4 min-w-4" [svgIcon]="isExpanded ? 'fa-solid:minus' : 'fa-solid:plus'"></mat-icon>
          </div>
        }
        <div class="flex flex-auto items-center" [ngClass]="{ 'pl-2': !hasChildren }">
          <mat-icon [svgIcon]="hasChildren ? (isExpanded ? 'fa-solid:folder-open' : 'fa-solid:folder-closed') : 'fa-solid:file'"></mat-icon>
          <div class="ml-3 h-full truncate">{{ instance.name }}</div>
        </div>
        <div
          class="m-1.5 hidden h-7 w-7 cursor-pointer items-center justify-center rounded-md hover:bg-gray-300 group-hover:flex hover:dark:bg-gray-700"
          [matMenuTriggerFor]="instanceMenu"
          [matMenuTriggerData]="{ $implicit: instance, depth }"
          (click)="$event.stopPropagation()"
        >
          <mat-icon class="h-4 min-h-4 w-4 min-w-4" svgIcon="fa-solid:ellipsis-vertical"></mat-icon>
        </div>
      </div>

      @if (hasChildren && isExpanded) {
        <div
          class="flex h-6 items-center pl-8 before:absolute before:start-3 before:top-10 before:ms-[calc(0.375rem+1px)] before:h-6 before:w-0.5 before:bg-gray-200 before:dark:bg-gray-800"
          [ngClass]="{ 'before:ms-[calc(2.375rem+1px)]': depth > 0 }"
        >
          <div class="inline-flex h-[1.375rem] select-none items-center rounded-md bg-gray-200 px-2 text-sm dark:bg-gray-800">
            {{ accessLevelNames[depth + 1] }}
          </div>
        </div>
        <ng-container *ngTemplateOutlet="instanceTemplate; context: { $implicit: instance.children, depth: depth + 1 }"></ng-container>
      }
    </div>
  }
</ng-template>

<mat-menu #instanceMenu="matMenu" overlapTrigger xPosition="before">
  <ng-template matMenuContent let-instance let-depth="depth">
    <div class="flex h-12 cursor-default items-center px-4" (click)="$event.stopPropagation()">
      <span class="flex flex-col leading-none">
        <span class="mt-1.5">{{ instance.name }}</span>
      </span>
    </div>
    <mat-divider class="my-2"></mat-divider>
    <button mat-menu-item>
      <mat-icon class="icon-size-5" svgIcon="fa-solid:pen"></mat-icon>
      <span>Rename</span>
    </button>
    @if (depth > 0) {
      <button mat-menu-item>
        <mat-icon class="icon-size-5" svgIcon="fa-solid:trash-can"></mat-icon>
        <span>Delete</span>
      </button>
    }
  </ng-template>
</mat-menu>
