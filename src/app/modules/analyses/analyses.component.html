<seed-page [config]="{ title: 'Analyses', titleIcon: 'fa-solid:chart-bar' }" *transloco="let t">
  <div class="flex-auto pt-4 sm:pt-6">
    <div class="bg-card flex flex-auto flex-col overflow-hidden rounded-2xl p-6 shadow sm:col-span-2 md:col-span-4">
      <div class="overflow-x-auto">
        <div class="mx-auto h-screen w-full max-w-screen-2xl">
          <mat-tab-group>
            <mat-tab label="{{ t('By Analysis') }}">
              <div class="mx-0 h-screen w-full max-w-screen-2xl">
                <mat-grid-list cols="14" gutterSize="0px" rowHeight="1:1" class="justify-center">
                  <mat-grid-tile [colspan]="2" class="header-row">{{ t('Analysis Name') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Actions') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Number of Properties') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Type') }}</mat-grid-tile>
                  <mat-grid-tile [colspan]="3" class="header-row">{{ t('Configuration') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Created') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Run Status') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Run Date') }}</mat-grid-tile>
                  <mat-grid-tile class="header-row">{{ t('Run Duration') }}</mat-grid-tile>
                  <mat-grid-tile [colspan]="2" class="header-row">{{ t('Run Cycle') }}</mat-grid-tile>
                </mat-grid-list>
                <mat-grid-list cols="14" gutterSize="0px" rowHeight="1:3">
                  @for (analysis of analyses; track trackByIdAndStatus(analysis)) {
                    <mat-grid-tile [colspan]="2" [class.alt-row]="$odd">
                      <a class="ml-1 text-primary-500 hover:underline focus:underline" [routerLink]="['/analyses', analysis.id]">{{ analysis.name }}</a>
                    </mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd">
                      <!-- actions -->
                      <!-- <i ng-show="menu.user.organization.user_role !== 'viewer'" class="glyphicon glyphicon-trash" title="Delete Analysis" aria-hidden="true" ng-click="delete_analysis(analysis.id)"></i> -->
                      @if (currentUser.org_role !== 'viewer') {
                        <button (click)="deleteAnalysis(analysis)"
                          aria-label="Delete Analysis"
                          title="Delete Analysis">
                          <mat-icon class="text-secondary icon-size-4" svgIcon="fa-solid:trash-can"></mat-icon>
                        </button>
                      }

                    </mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd">{{ analysis.number_of_analysis_property_views }}</mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd">{{ analysis.service }}</mat-grid-tile>
                    <mat-grid-tile [colspan]="3" [class.alt-row]="$odd">
                      <div class="tile-content">
                        <ul class="list-disc list-outside m-0 p-4">
                          <!-- iterate over the hash display key - value pairs -->
                          @for (key of getKeys(analysis.configuration); track key) {
                            <li *ngIf="typeof analysis.configuration[key] !== 'object'"><strong>{{ key }}</strong>: {{ analysis.configuration[key] }}</li>
                          }
                        </ul>
                      </div>
                    </mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd">{{ analysis.created_at | date : 'MM-dd-yy HH:mm' }}</mat-grid-tile>
                    <mat-grid-tile class="analysis-status" [class.alt-row]="$odd" [ngClass]="analysis.status.toLowerCase()">
                      <i class="fa-solid fa-arrows-rotate fa-spin-pulse fa-fw" style="padding-right: 0" ng-if="!analysis._finished_with_tasks"></i>
                      {{ analysis.status }}
                    </mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd" class="pad-row">{{ analysis.start_time | date : 'MM-dd-yy HH:mm' }}</mat-grid-tile>
                    <mat-grid-tile [class.alt-row]="$odd">{{ runDuration(analysis) }}</mat-grid-tile>
                    <mat-grid-tile [colspan]="2" [class.alt-row]="$odd">{{ cycle(analysis.cycles[0]) }}</mat-grid-tile>
                  }
                </mat-grid-list>
              </div>
            </mat-tab>
            <mat-tab label="{{ t('By Property') }}">
              <div>
                @for (view of views; track view.id) {
                  <mat-card appearance="outlined" class="mb-2" [class.even-card]="$even">
                    <mat-card-header>
                      <mat-card-title-group>
                        <mat-card-title>
                          <a class="ml-1 text-primary-500 hover:underline focus:underline" [routerLink]="['/analyses', view.analysis, '/runs', view.id]">Run ID {{ view.id }}</a>
                        </mat-card-title>
                      </mat-card-title-group>
                    </mat-card-header>
                    <mat-card-content>
                      <mat-grid-list cols="5" rowHeight="1:1" gutterSize="20px">
                        <mat-grid-tile>
                          <a class="ml-1 text-primary-500 hover:underline focus:underline" [routerLink]="['/properties', originalViews[view.id]]">{{ view.display_name || 'Property ' + originalViews[view.id] }}</a>
                        </mat-grid-tile>
                        <mat-grid-tile colspan="4" class="mb-0">
                          <div>
                          @if (filteredMessages(view.id); as items) {
                            <ul class="md:list-disc list-outside m-0 p-4">
                              @for (message of items; track message.id) {
                                <li class="pb-2">
                                  {{ message['user_message'] }}<span ng-if="message['debug_message']"> - {{ message['debug_message'] }}</span>
                                </li>
                              }
                            </ul>
                          }
                          </div>
                        </mat-grid-tile>
                      </mat-grid-list>
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>
    </div>
  </div>
</seed-page>
